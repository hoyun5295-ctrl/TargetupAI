# 한줄로 — 확장 아키텍처 & 인비토AI 로드맵 (SCALING)

> **관련 문서:** STATUS.md | OPS.md | SCHEMA.md
> **생성일:** 2026-02-25
> **목적:** 상용화 이후 성장 계획. 멀티노드 수평 확장 + 자체 AI 엔진 전환 로드맵.
> **착수 시점:** 상용화 안정화 이후 Harold님 판단에 따라 진행

---

## 1) 현재 인프라 현황 (단일 서버)

### 서버 스펙 (IDC)
| 항목 | 스펙 |
|------|------|
| CPU | 8코어 |
| RAM | 62GB |
| PostgreSQL | Docker (shared_buffers 4GB, effective_cache_size 48GB) |
| MySQL | Docker (QTmsg 전용) |
| Redis | Docker (캐싱) |
| QTmsg Agent | 11개 (대량발송 9 + 테스트 1 + 인증 1) |
| 스팸필터 테스트폰 | 3대 (SKT/KT/LGU+) |
| 프로세스 관리 | PM2 (싱글 프로세스) |

### 단일 서버 수용 용량 (베이직 고객사 기준: 고객 30만 + 캠페인 500건 + 구매 5만건)

| 시나리오 | 고객사 수 | 총 고객 수 | 쾌적도 |
|----------|----------|-----------|--------|
| 안정적 운영 | 10~15개 | 300~450만 | ✅ 쾌적 (인프라 변경 불필요) |
| 관리 가능 | 20~30개 | 600~900만 | ⚠️ 모니터링 필요, 일부 쿼리 최적화 추가 |
| 한계선 | 40~50개 | 1,200~1,500만 | 🔴 인프라 업그레이드 필수 |

### 병목 포인트
1. **PostgreSQL** — customers 테이블이 고객사 비례 증가. 900만 이상 시 인덱스 디스크 I/O 증가
2. **PM2 싱글 프로세스** — 동시 접속 10~20명 이상 시 응답 지연
3. **QTmsg 라인그룹** — 대량발송 동시 3개 고객사가 현재 한계 (라인그룹 3개 × Agent 3개)
4. **디스크** — 고객사 1개 ≈ 350MB. 100개여도 35GB로 디스크는 여유

### 확장에 유리한 현재 구조 (그대로 가져갈 수 있는 것)
- ✅ company_id 기반 전 테이블 데이터 격리
- ✅ 라인그룹 분리 (고객사별 QTmsg 독립 운영)
- ✅ Redis 캐싱 company_id 키 기반
- ✅ 멀티 도메인 분리 (hanjul.ai / app.hanjul.ai / sys.hanjullo.com)

---

## 2) Phase 1 — 멀티노드 수평 확장

### 목표
고객사 20개마다 서비스 노드 1대 추가. 슈퍼관리자는 중앙 1곳에서 전체 노드 통합 관리.

### 구조
```
┌─────────────────────────────────────────────────────┐
│              sys.hanjullo.com (중앙 관리)              │
│         슈퍼관리자 전용 서버 (컨트롤 플레인)              │
│     - 전체 고객사 목록 / 노드 배정                      │
│     - 통합 정산 / 통합 통계                            │
│     - 노드별 API 호출로 데이터 수집                     │
└────────┬──────────────┬──────────────┬──────────────┘
         │              │              │
    ┌────▼────┐    ┌────▼────┐    ┌────▼────┐
    │ 노드 1   │    │ 노드 2   │    │ 노드 3   │    ...
    │ 고객사   │    │ 고객사   │    │ 고객사   │
    │ 1~20    │    │ 21~40   │    │ 41~60   │
    │         │    │         │    │         │
    │ PG+MySQL│    │ PG+MySQL│    │ PG+MySQL│
    │ Redis   │    │ Redis   │    │ Redis   │
    │ QTmsg×11│    │ QTmsg×11│    │ QTmsg×11│
    │ 테스트폰3│    │ 테스트폰3│    │ 테스트폰3│
    │ PM2     │    │ PM2     │    │ PM2     │
    └─────────┘    └─────────┘    └─────────┘
```

### 노드 1대 = 독립 서비스 단위
- hanjul.ai + app.hanjul.ai (해당 노드 고객사만 서비스)
- PostgreSQL + MySQL + Redis
- QTmsg Agent 11개
- 스팸필터 테스트폰 3대 (SKT/KT/LGU+)
- PM2 프로세스 관리

### 현재 구조에서 변경 필요 사항

| 영역 | 현재 | 변경 필요 |
|------|------|----------|
| DB 연결 | `.env`의 PG/MySQL 1대만 연결 | 노드는 그대로. 슈퍼관리자만 멀티 DB 커넥션 |
| 고객사 라우팅 | 없음 (단일 서버) | 로그인 시 고객사→노드 매핑 후 해당 노드 API로 연결 |
| 슈퍼관리자 | 로컬 DB 직접 SELECT | 노드 레지스트리 + 노드별 API 호출 통합 조회 |
| 노드 정보 | 없음 | 슈퍼관리자 DB에 nodes 테이블 (노드 URL, 상태, 배정 고객사 수) |

### 확장 방향 2가지 (착수 시 선택)

**방향 A: 슈퍼관리자 중앙화 (권장)**
- sys.hanjullo.com은 전용 관리 서버에만 존재
- 각 노드에는 서비스(hanjul.ai + app.hanjul.ai) + DB + QTmsg만 운영
- 슈퍼관리자가 각 노드 API를 호출해서 통합 조회
- 장점: 관리포인트 1개, 노드 추가 = 서버 복제 + 노드 등록만
- 단점: 슈퍼관리자 백엔드에 "노드 연동 레이어" 개발 필요

**방향 B: DB만 중앙화**
- 슈퍼관리자용 PostgreSQL을 별도 서버에 두고, 모든 노드가 로컬 DB + 중앙 관리 DB 둘 다 연결
- 고객사 목록·정산·통계는 중앙 DB, 캠페인·고객·발송은 로컬 DB
- 장점: 구현이 상대적으로 단순
- 단점: 중앙 DB가 단일 장애점(SPOF)

### 점진적 전환 가능 포인트 (상용화 전/중에 미리 준비 가능)
- 슈퍼관리자 API가 로컬 DB 직접 JOIN → 노드 API 호출 방식으로 점진 전환
- 노드 레지스트리 테이블 스키마 사전 설계

---

## 3) Phase 2 — 인비토AI 데이터 축적 & 파인튜닝

### 목표
한줄로에 축적되는 실전 마케팅 데이터로 **메시징/마케팅 특화 AI 엔진** 개발.
범용 대화형 AI가 아닌, **입력 → 결과 전용 마케팅 도구 모델**.

### 인비토AI 정의
- ❌ 범용 챗봇 / 대화형 AI 아님
- ✅ 마케팅 메시지 생성 + 타겟 추출 + 스팸 회피 특화 엔진
- 입력: 마케팅 의도 (자연어 명령)
- 출력: 타겟 조건 + 메시지 문안 + 채널 추천
- 대화 기능 없음 → 모델 경량화 + 학습 속도 ↑ + 정확도 ↑

### 데이터 수집 현황 (이미 운영 중)

**ai_training_logs 테이블 — 자동 적재 중**

| 수집 데이터 | 소스 | 용도 |
|------------|------|------|
| 자연어 명령 (입력) | AI 발송 시 사용자 입력 | 의도 파악 학습 |
| 타겟 추출 결과 (SQL 조건) | Claude 응답 → 실제 추출 수 | 타겟팅 정확도 학습 |
| 생성된 메시지 문안 | Claude 응답 | 메시지 톤/패턴 학습 |
| 발송 성공/실패율 | campaign_runs 결과 동기화 | 품질 피드백 |
| 스팸 차단 여부 | 스팸필터 테스트 결과 | 스팸 회피 패턴 학습 |
| 채널별 성과 (SMS/LMS/MMS) | 결과 코드 | 채널 추천 최적화 |
| 업종·고객 세그먼트 | 고객사 업종 + 고객 등급 분포 | 업종별 특화 |

- 마스킹 처리 적용 (개인정보 비식별화)
- Claude + GPT + Gemini 3자 토론 방식으로 데이터 구조 확정
- training-logger.ts 유틸로 campaigns.ts에서 자동 적재

### 파인튜닝 방식
- 기존 LLM (Claude, GPT 등)을 베이스 모델로 사용
- 축적된 ai_training_logs 데이터로 파인튜닝 (재학습)
- 모델을 처음부터 만드는 것이 아님 → 데이터만 충분하면 비교적 빠르게 생산 가능
- 학습 시작 후 지속적으로 개선 (고객사 사용 데이터가 계속 유입)

### 데이터 해자 (경쟁 우위)
인비토AI의 핵심 가치는 모델 아키텍처가 아닌 **데이터**:
- 한국 통신사 3사 스팸필터 실제 차단/통과 패턴
- 업종별 마케팅 메시지 성공률 실데이터
- 광고법·전기통신사업법 준수 패턴
- 고객 세그먼트별 반응률 (등급, 성별, 지역, 구매이력)
- 시간대/요일별 최적 발송 타이밍 실증 데이터

→ 돈 주고 살 수 없는 데이터. 고객사가 쓸수록 모델이 똑똑해지는 선순환.

---

## 4) Phase 3 — Claude API → 인비토AI 교체

### 현재 Claude API 호출 지점 (교체 대상)

| 기능 | 파일 | 호출 빈도 | 교체 효과 |
|------|------|----------|----------|
| 타겟 추출 (자연어 → SQL) | ai.ts | 매 AI 발송 | 핵심. 가장 높은 호출량 |
| 메시지 생성 | ai.ts | 매 AI 발송 | 핵심. 톤·스팸회피 특화 가능 |
| AI 분석 (인사이트) | analysis.ts | 분석 실행 시 | 프로: 1회, 비즈니스: 3회 호출 |
| 브리핑 파싱 (의도 분류) | ai.ts | 매 입력 | 경량 분류 모델로 대체 가능 |

### 비용 구조 전환

| 항목 | Claude API (현재) | 인비토AI (전환 후) |
|------|-------------------|-------------------|
| 과금 방식 | 토큰 종량제 | 자체 서버 GPU 고정비 |
| 고객사 증가 시 | 비용 비례 증가 | 고정비 (서버 추가 시 점프) |
| 고객사 50개 기준 | 월 수백만원 예상 | GPU 서버 1대 고정비 |
| 고객사 200개 기준 | 월 수천만원 예상 | GPU 서버 2~3대 |

→ 규모가 커질수록 비용 차이 극대화

### 사업 확장 가능성

인비토AI는 한줄로 내장 엔진을 넘어 **독립 상품**으로 판매 가능:

| 판매 형태 | 대상 | 설명 |
|----------|------|------|
| API (B2B) | 타 메시징 플랫폼 | 엔진만 제공. 메시지 생성 + 타겟 추출 API |
| SaaS 내장 | 한줄로 자체 | 자체 플랫폼 원가 절감 + 성능 차별화 |
| 라이선스 | 대기업 마케팅팀 | 온프레미스 납품. 자체 인프라에 설치형 |
| 화이트라벨 | 광고대행사 | 자사 브랜드로 재판매 허용 |

→ 한줄로는 SaaS 사업, 인비토AI는 **플랫폼 사업**으로 확장

---

## 5) 선행 조건 & 체크리스트

### Phase 1 착수 전
- [ ] 상용화 안정화 확인 (고객사 10개+ 안정 운영)
- [ ] 노드 레지스트리 테이블 스키마 설계
- [ ] 슈퍼관리자 API 노드 연동 레이어 설계
- [ ] 확장 방향 최종 선택 (A: 슈퍼관리자 중앙화 vs B: DB 중앙화)

### Phase 2 착수 전
- [ ] ai_training_logs 데이터 충분 축적 (목표: 10만 건+)
- [ ] 이용약관에 비식별 데이터 활용 조항 추가
- [ ] 파인튜닝 파트너/플랫폼 선정 (OpenAI fine-tuning, 자체 호스팅 등)
- [ ] GPU 서버 인프라 검토

### Phase 3 착수 전
- [ ] 인비토AI 정확도 검증 (Claude 대비 동등 이상)
- [ ] 전환 테스트 (A/B: Claude vs 인비토AI 병행 운영)
- [ ] 롤백 플랜 (인비토AI 장애 시 Claude 즉시 전환)

---

## 6) DECISION LOG

| ID | 날짜 | 결정 | 근거 |
|----|------|------|------|
| S1 | 02-25 | 멀티노드 설계는 상용화 이후 착수 | 현재는 단일 서버 20개 고객사까지 쾌적. 조기 최적화 방지 |
| S2 | 02-25 | 슈퍼관리자 중앙화(방향 A) 우선 검토 | 관리포인트 1개 유지가 운영 효율에 핵심 |
| S3 | 02-25 | 인비토AI는 범용 챗봇이 아닌 마케팅 엔진 | 대화 기능 제외 → 경량/고정밀/빠른 학습. 도구형 모델 |
| S4 | 02-25 | 데이터 축적은 이미 진행 중 (ai_training_logs) | 상용화 후 고객사 데이터 유입 시 자연 가속 |

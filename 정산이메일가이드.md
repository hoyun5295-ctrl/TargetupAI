# 정산서 이메일 발송 기능 구현 가이드

## 1. DB 마이그레이션 (PostgreSQL)

```sql
-- billings 테이블에 이메일 발송 이력 컬럼 추가
ALTER TABLE billings ADD COLUMN emailed_at timestamptz;
ALTER TABLE billings ADD COLUMN emailed_to varchar(100);
ALTER TABLE billings ADD COLUMN emailed_by uuid;
```

실행:
```bash
docker exec -it targetup-postgres psql -U targetup targetup
```

---

## 2. 백엔드: 이메일 서비스 stub 파일 생성

**새 파일**: `packages/backend/src/services/emailService.ts`

→ 별도 파일로 제공 (billing-email-service.ts)

---

## 3. 백엔드: API 엔드포인트 추가

**파일**: `packages/backend/src/routes/admin.ts` (또는 billing 관련 라우트 파일)

기존 billing PDF 다운로드 라우트 근처에 추가:

```typescript
// ===== 정산서 이메일 발송 =====
router.post('/billing/:id/send-email', async (req: any, res) => {
  try {
    const { id } = req.params;
    const { to, subject, body_html } = req.body;
    const adminId = req.user?.id || req.adminUser?.id;

    if (!to || !subject) {
      return res.status(400).json({ error: '수신자 이메일과 제목은 필수입니다' });
    }

    // 1) billing 조회 + 상태 체크
    const billingResult = await pool.query(
      'SELECT * FROM billings WHERE id = $1', [id]
    );
    if (billingResult.rows.length === 0) {
      return res.status(404).json({ error: '정산 데이터를 찾을 수 없습니다' });
    }
    const billing = billingResult.rows[0];
    if (billing.status === 'draft') {
      return res.status(400).json({ error: '초안 상태에서는 발송할 수 없습니다. 확정 후 발송해주세요.' });
    }

    // 2) PDF 생성 (기존 PDF 생성 로직 재활용)
    //    ※ 기존 billing PDF 생성 함수를 여기서 호출하여 Buffer로 받기
    //    예: const pdfBuffer = await generateBillingPdf(id);
    //    현재는 stub이므로 PDF 생성까지만 확인

    // 3) 이메일 발송 (현재 stub)
    const { sendBillingEmail } = require('../services/emailService');
    const emailResult = await sendBillingEmail({
      to,
      subject,
      bodyHtml: body_html,
      pdfBuffer: null, // TODO: 실제 PDF buffer 연결
      pdfFilename: `정산서_${billing.company_name || 'billing'}_${billing.billing_year}_${billing.billing_month}.pdf`,
    });

    // 4) 발송 이력 기록
    if (emailResult.success) {
      await pool.query(
        'UPDATE billings SET emailed_at = NOW(), emailed_to = $1, emailed_by = $2 WHERE id = $3',
        [to, adminId, id]
      );
    }

    res.json({
      success: emailResult.success,
      message: emailResult.message,
      emailed_at: new Date().toISOString(),
      emailed_to: to,
    });
  } catch (error: any) {
    console.error('정산서 이메일 발송 오류:', error);
    res.status(500).json({ error: error.message || '이메일 발송 실패' });
  }
});
```

---

## 4. 프론트엔드: API 클라이언트 추가

**파일**: `packages/frontend/src/api/client.ts`

billingApi 객체 안에 추가:

```typescript
// 기존 billingApi 안에 메서드 추가
sendBillingEmail: (id: string, data: { to: string; subject: string; body_html: string }) =>
  api.post(`/admin/billing/${id}/send-email`, data),
```

---

## 5. 프론트엔드: AdminDashboard.tsx 변경사항

### 5-1. State 추가 (line 201 부근, billingToast 뒤에)

기존코드:
```typescript
const [billingToast, setBillingToast] = useState<{ msg: string; type: 'success' | 'error' } | null>(null);
```

새코드:
```typescript
const [billingToast, setBillingToast] = useState<{ msg: string; type: 'success' | 'error' } | null>(null);
// 정산서 이메일 발송
const [showEmailModal, setShowEmailModal] = useState(false);
const [emailTarget, setEmailTarget] = useState<any>(null);
const [emailTo, setEmailTo] = useState('');
const [emailSubject, setEmailSubject] = useState('');
const [emailSending, setEmailSending] = useState(false);
```

### 5-2. 이메일 발송 함수 추가 (line 330 billingYearOptions 뒤에)

기존코드:
```typescript
const billingYearOptions = [billingCurrentYear - 1, billingCurrentYear, billingCurrentYear + 1];
```

새코드:
```typescript
const billingYearOptions = [billingCurrentYear - 1, billingCurrentYear, billingCurrentYear + 1];

// 정산서 이메일 발송 모달 열기
const openEmailModal = (billing: any) => {
  const company = companies.find(c => c.id === billing.company_id);
  setEmailTarget(billing);
  setEmailTo(company?.contact_email || '');
  setEmailSubject(`[인비토] ${billing.company_name} ${billing.billing_year}년 ${billing.billing_month}월 거래내역서`);
  setShowEmailModal(true);
};

// 정산서 이메일 발송 처리
const handleSendBillingEmail = async () => {
  if (!emailTo) return setBillingToast({ msg: '수신자 이메일을 입력해주세요', type: 'error' });
  if (!emailTarget) return;
  setEmailSending(true);
  try {
    const bodyHtml = `
      <div style="font-family:'Apple SD Gothic Neo','맑은 고딕',sans-serif;max-width:600px;margin:0 auto;padding:24px;">
        <div style="border-bottom:3px solid #4F46E5;padding-bottom:16px;margin-bottom:24px;">
          <h2 style="margin:0;color:#1F2937;font-size:20px;">INVITO 거래내역서</h2>
        </div>
        <p style="color:#374151;font-size:14px;line-height:1.8;">
          안녕하세요, <strong>${emailTarget.company_name}</strong> 담당자님.<br/>
          아래와 같이 거래내역서를 송부드립니다.
        </p>
        <div style="background:#F3F4F6;border-radius:8px;padding:20px;margin:20px 0;">
          <table style="width:100%;border-collapse:collapse;font-size:14px;color:#374151;">
            <tr><td style="padding:6px 0;color:#6B7280;">정산 기간</td><td style="padding:6px 0;text-align:right;font-weight:600;">${emailTarget.billing_year}년 ${emailTarget.billing_month}월</td></tr>
            <tr><td style="padding:6px 0;color:#6B7280;">공급가액</td><td style="padding:6px 0;text-align:right;">₩${Number(emailTarget.subtotal || 0).toLocaleString('ko-KR')}</td></tr>
            <tr><td style="padding:6px 0;color:#6B7280;">부가세</td><td style="padding:6px 0;text-align:right;">₩${Number(emailTarget.vat || 0).toLocaleString('ko-KR')}</td></tr>
            <tr style="border-top:2px solid #D1D5DB;"><td style="padding:10px 0 6px;color:#1F2937;font-weight:700;">합계</td><td style="padding:10px 0 6px;text-align:right;font-weight:700;color:#4F46E5;font-size:18px;">₩${Number(emailTarget.total_amount || 0).toLocaleString('ko-KR')}</td></tr>
          </table>
        </div>
        <p style="color:#374151;font-size:14px;line-height:1.8;">
          첨부된 거래내역서(PDF)를 확인해 주세요.<br/>
          문의사항이 있으시면 아래 연락처로 연락 부탁드립니다.
        </p>
        <div style="margin-top:32px;padding-top:16px;border-top:1px solid #E5E7EB;color:#9CA3AF;font-size:12px;">
          <strong style="color:#6B7280;">주식회사 인비토 (INVITO Corp.)</strong><br/>
          이메일: mobile@invitocorp.com
        </div>
      </div>
    `;
    const res = await billingApi.sendBillingEmail(emailTarget.id, {
      to: emailTo,
      subject: emailSubject,
      body_html: bodyHtml,
    });
    setBillingToast({ msg: res.data.message || '정산서가 발송되었습니다', type: 'success' });
    setShowEmailModal(false);
    // 발송 이력 반영
    if (detailBilling?.id === emailTarget.id) {
      setDetailBilling((prev: any) => prev ? { ...prev, emailed_at: res.data.emailed_at, emailed_to: res.data.emailed_to } : prev);
    }
    loadBillings();
  } catch (e: any) {
    setBillingToast({ msg: e.response?.data?.error || '이메일 발송 실패', type: 'error' });
  } finally {
    setEmailSending(false);
  }
};
```

### 5-3. 정산 목록 테이블 - "발송" 버튼 추가 (line 3985 부근)

기존코드:
```tsx
                            <button onClick={() => downloadBillingPdf(b.id, `${b.company_name}_${b.billing_year}_${b.billing_month}`)}
                              className="px-2 py-1 text-xs bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition-colors">PDF</button>
```

새코드:
```tsx
                            <button onClick={() => downloadBillingPdf(b.id, `${b.company_name}_${b.billing_year}_${b.billing_month}`)}
                              className="px-2 py-1 text-xs bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition-colors">PDF</button>
                            {(b.status === 'confirmed' || b.status === 'paid') && (
                              <button onClick={() => openEmailModal(b)}
                                className="px-2 py-1 text-xs bg-amber-100 text-amber-700 rounded hover:bg-amber-200 transition-colors flex items-center gap-0.5">
                                <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                                발송
                              </button>
                            )}
```

### 5-4. 정산 목록 테이블 헤더 - "발송일" 컬럼 추가 (line 3957 부근)

기존코드:
```tsx
                      <th className="px-4 py-2.5 text-center text-gray-600 font-medium">상태</th>
                      <th className="px-4 py-2.5 text-center text-gray-600 font-medium">관리</th>
```

새코드:
```tsx
                      <th className="px-4 py-2.5 text-center text-gray-600 font-medium">상태</th>
                      <th className="px-4 py-2.5 text-center text-gray-600 font-medium">발송일</th>
                      <th className="px-4 py-2.5 text-center text-gray-600 font-medium">관리</th>
```

### 5-5. 정산 목록 테이블 바디 - "발송일" 셀 추가 (line 3970 부근)

기존코드:
```tsx
                        <td className="px-4 py-2.5 text-center">{billingStatusBadge(b.status)}</td>
                        <td className="px-4 py-2.5 text-center" onClick={e => e.stopPropagation()}>
```

새코드:
```tsx
                        <td className="px-4 py-2.5 text-center">{billingStatusBadge(b.status)}</td>
                        <td className="px-4 py-2.5 text-center text-xs text-gray-500">
                          {b.emailed_at ? (
                            <span className="inline-flex items-center gap-1 text-green-600" title={`${b.emailed_to}\n${new Date(b.emailed_at).toLocaleString('ko-KR')}`}>
                              <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
                              {new Date(b.emailed_at).toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric' })}
                            </span>
                          ) : (
                            <span className="text-gray-300">—</span>
                          )}
                        </td>
                        <td className="px-4 py-2.5 text-center" onClick={e => e.stopPropagation()}>
```

### 5-6. 정산 상세 모달 하단 - "정산서 발송" 버튼 추가 (line 4280 부근)

기존코드:
```tsx
                      <button onClick={() => downloadBillingPdf(detailBilling.id, `${detailBilling.company_name}_${detailBilling.billing_year}_${detailBilling.billing_month}`)}
                        className="px-4 py-1.5 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-1.5">
                        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        PDF 다운로드
                      </button>
                      <button onClick={() => setShowBillingDetail(false)}
                        className="px-4 py-1.5 text-sm text-gray-600 border rounded-lg hover:bg-gray-100 transition-colors">닫기</button>
```

새코드:
```tsx
                      {(detailBilling.status === 'confirmed' || detailBilling.status === 'paid') && (
                        <button onClick={() => { setShowBillingDetail(false); setTimeout(() => openEmailModal(detailBilling), 200); }}
                          className="px-4 py-1.5 text-sm bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors flex items-center gap-1.5">
                          <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                          </svg>
                          정산서 발송
                        </button>
                      )}
                      <button onClick={() => downloadBillingPdf(detailBilling.id, `${detailBilling.company_name}_${detailBilling.billing_year}_${detailBilling.billing_month}`)}
                        className="px-4 py-1.5 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-1.5">
                        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        PDF 다운로드
                      </button>
                      <button onClick={() => setShowBillingDetail(false)}
                        className="px-4 py-1.5 text-sm text-gray-600 border rounded-lg hover:bg-gray-100 transition-colors">닫기</button>
```

### 5-7. 정산 상세 모달 헤더 - 이전 발송 이력 표시 (line 4134 부근)

기존코드:
```tsx
                    {detailBilling && (
                      <p className="text-sm text-gray-500 mt-0.5">
                        {detailBilling.company_name} · {detailBilling.billing_year}년 {detailBilling.billing_month}월
                        {detailBilling.user_name && <span className="ml-2 text-indigo-600">({detailBilling.user_name})</span>}
                      </p>
                    )}
```

새코드:
```tsx
                    {detailBilling && (
                      <div>
                        <p className="text-sm text-gray-500 mt-0.5">
                          {detailBilling.company_name} · {detailBilling.billing_year}년 {detailBilling.billing_month}월
                          {detailBilling.user_name && <span className="ml-2 text-indigo-600">({detailBilling.user_name})</span>}
                        </p>
                        {detailBilling.emailed_at && (
                          <p className="text-xs text-green-600 mt-1 flex items-center gap-1">
                            <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
                            {new Date(detailBilling.emailed_at).toLocaleString('ko-KR')} · {detailBilling.emailed_to}로 발송됨
                          </p>
                        )}
                      </div>
                    )}
```

### 5-8. 이메일 발송 모달 추가 (line 4294, 정산 상세 모달 닫힌 직후)

기존코드:
```tsx
          )}
        </div>
      )}
      </main>
```

새코드:
```tsx
          )}

          {/* ===== 정산서 이메일 발송 모달 ===== */}
          {showEmailModal && emailTarget && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60]">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
                <div className="p-6">
                  <div className="w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center mx-auto mb-4">
                    <svg className="w-6 h-6 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                  </div>
                  <h3 className="text-lg font-semibold text-center text-gray-900 mb-2">정산서 이메일 발송</h3>
                  <p className="text-sm text-center text-gray-500 mb-5">
                    <strong>{emailTarget.company_name}</strong> · {emailTarget.billing_year}년 {emailTarget.billing_month}월
                  </p>

                  {/* 이전 발송 이력 */}
                  {emailTarget.emailed_at && (
                    <div className="bg-green-50 border border-green-200 rounded-lg px-3 py-2 mb-4 text-xs text-green-700 flex items-center gap-1.5">
                      <svg className="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                      이전 발송: {new Date(emailTarget.emailed_at).toLocaleString('ko-KR')} → {emailTarget.emailed_to}
                    </div>
                  )}

                  {/* 수신자 이메일 */}
                  <div className="mb-3">
                    <label className="block text-xs font-medium text-gray-500 mb-1">수신자 이메일</label>
                    <input
                      type="email"
                      value={emailTo}
                      onChange={e => setEmailTo(e.target.value)}
                      className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-amber-500 outline-none"
                      placeholder="담당자 이메일"
                    />
                  </div>

                  {/* 메일 제목 */}
                  <div className="mb-3">
                    <label className="block text-xs font-medium text-gray-500 mb-1">메일 제목</label>
                    <input
                      type="text"
                      value={emailSubject}
                      onChange={e => setEmailSubject(e.target.value)}
                      className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-amber-500 outline-none"
                    />
                  </div>

                  {/* 본문 미리보기 */}
                  <div className="mb-3">
                    <label className="block text-xs font-medium text-gray-500 mb-1">본문 미리보기</label>
                    <div className="border rounded-lg p-3 bg-gray-50 text-xs text-gray-600 space-y-1.5 max-h-[140px] overflow-y-auto">
                      <p>안녕하세요, <strong>{emailTarget.company_name}</strong> 담당자님.</p>
                      <p>아래와 같이 거래내역서를 송부드립니다.</p>
                      <div className="bg-white rounded p-2 mt-2 border">
                        <div className="flex justify-between"><span className="text-gray-400">정산 기간</span><span className="font-medium">{emailTarget.billing_year}년 {emailTarget.billing_month}월</span></div>
                        <div className="flex justify-between"><span className="text-gray-400">공급가액</span><span>{billingFmtWon(Number(emailTarget.subtotal || 0))}</span></div>
                        <div className="flex justify-between"><span className="text-gray-400">부가세</span><span>{billingFmtWon(Number(emailTarget.vat || 0))}</span></div>
                        <div className="flex justify-between border-t pt-1 mt-1"><span className="font-bold">합계</span><span className="font-bold text-indigo-700">{billingFmtWon(Number(emailTarget.total_amount || 0))}</span></div>
                      </div>
                      <p className="text-gray-400 mt-2">+ 거래내역서 PDF 첨부</p>
                    </div>
                  </div>

                  {/* 발신 정보 */}
                  <div className="bg-gray-50 rounded-lg px-3 py-2 text-xs text-gray-400">
                    발신: mobile@invitocorp.com (하이웍스)
                  </div>
                </div>

                <div className="flex border-t">
                  <button
                    onClick={() => setShowEmailModal(false)}
                    className="flex-1 px-4 py-3 text-gray-700 font-medium hover:bg-gray-50 transition-colors border-r"
                    disabled={emailSending}
                  >
                    취소
                  </button>
                  <button
                    onClick={handleSendBillingEmail}
                    disabled={emailSending || !emailTo}
                    className="flex-1 px-4 py-3 text-amber-600 font-medium hover:bg-amber-50 transition-colors disabled:opacity-50 flex items-center justify-center gap-1.5"
                  >
                    {emailSending ? (
                      <>
                        <svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                        발송 중...
                      </>
                    ) : (
                      <>
                        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                        발송하기
                      </>
                    )}
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      )}
      </main>
```

---

## 나중에 SMTP 연결 시 (TODO)

`packages/backend/src/services/emailService.ts`에서 stub을 실제 nodemailer로 교체:

```typescript
import nodemailer from 'nodemailer';

const transporter = nodemailer.createTransport({
  host: 'smtps.hiworks.com',
  port: 587,
  secure: false,
  auth: {
    user: process.env.HIWORKS_EMAIL,       // mobile@invitocorp.com
    pass: process.env.HIWORKS_PASSWORD,    // 해당 계정 비밀번호
  },
});

// sendBillingEmail 함수 내부에서:
await transporter.sendMail({
  from: '"인비토" <mobile@invitocorp.com>',
  to,
  subject,
  html: bodyHtml,
  attachments: [{ filename: pdfFilename, content: pdfBuffer }],
});
```

하이웍스 사전 설정:
1. mobile@invitocorp.com 로그인 → 메일 → 환경설정 → POP3/SMTP → "사용함"
2. 운영 서버 IP를 하이웍스 접근 허용 IP에 추가
